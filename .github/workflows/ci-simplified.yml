name: CI - Simplified Validation

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ==========================================
  # Job 1: Data Validation & Drift Detection
  # ==========================================
  data-validation:
    name: Data Validation & Drift Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy scipy scikit-learn
        
    - name: Run Data Validation
      run: |
        python tests/validate_data.py data/raw/ChurnModelling.csv
      continue-on-error: false
      
    - name: Upload Data Validation Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: data-validation-report
        path: reports/data_validation_report.json
        retention-days: 30

  # ==========================================
  # Job 2: Model Performance Validation
  # ==========================================
  model-validation:
    name: Model Performance Validation (F1 >= 75%)
    runs-on: ubuntu-latest
    needs: data-validation
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
      
    - name: Download Latest Model from S3
      run: |
        # Download latest trained model
        aws s3 cp s3://${{ secrets.S3_BUCKET }}/models/best_model.pkl artifacts/models/best_model.pkl --region ${{ secrets.AWS_DEFAULT_REGION }} || echo "No model in S3 yet"
        
        # Download test data
        aws s3 cp s3://${{ secrets.S3_BUCKET }}/data/test_data.pkl artifacts/data/test_data.pkl --region ${{ secrets.AWS_DEFAULT_REGION }} || echo "No test data in S3 yet"
      continue-on-error: true
      
    - name: Validate Model Performance
      run: |
        # Check if model and test data exist
        if [ -f "artifacts/models/best_model.pkl" ] && [ -f "artifacts/data/test_data.pkl" ]; then
          echo "üéØ Running model validation..."
          python tests/validate_model.py artifacts/models/best_model.pkl artifacts/data/test_data.pkl
        else
          echo "‚ö†Ô∏è  Model or test data not found. Skipping validation."
          echo "   This is expected for first-time setup."
          exit 0
        fi
      
    - name: Upload Model Validation Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: model-validation-report
        path: reports/model_validation_report.json
        retention-days: 90
        
    - name: Block Deployment on Low Performance
      if: failure()
      run: |
        echo "::error::Model performance below threshold (F1 < 75%)"
        echo "::error::Deployment blocked. Please retrain model."
        exit 1

  # ==========================================
  # Job 3: Validation Summary
  # ==========================================
  validation-summary:
    name: CI Validation Summary
    runs-on: ubuntu-latest
    needs: [data-validation, model-validation]
    if: always()
    
    steps:
    - name: Check Validation Status
      run: |
        echo "=" | head -c 70; echo
        echo "üìä CI VALIDATION SUMMARY"
        echo "=" | head -c 70; echo
        echo ""
        echo "‚úÖ Data Validation: ${{ needs.data-validation.result }}"
        echo "‚úÖ Model Validation: ${{ needs.model-validation.result }}"
        echo ""
        
        if [ "${{ needs.data-validation.result }}" != "success" ]; then
          echo "‚ùå Data validation failed!"
          echo "   - Check data schema and quality"
          echo "   - Review data validation report"
          exit 1
        fi
        
        if [ "${{ needs.model-validation.result }}" == "failure" ]; then
          echo "‚ùå Model validation failed!"
          echo "   - Model F1 score below 75% threshold"
          echo "   - Deployment blocked"
          echo "   - Retrain model or adjust thresholds"
          exit 1
        fi
        
        if [ "${{ needs.model-validation.result }}" == "skipped" ]; then
          echo "‚ö†Ô∏è  Model validation skipped (no model available yet)"
          echo "   This is normal for first-time setup"
        fi
        
        echo ""
        echo "üéâ All validations passed!"
        echo "=" | head -c 70; echo
        
    - name: Notify on Failure
      if: |
        needs.data-validation.result == 'failure' ||
        needs.model-validation.result == 'failure'
      run: |
        echo "::error::CI validation failed. Deployment blocked."
        exit 1

